from flask import Flask, request, jsonify
import speech_recognition as sr
import os
import difflib
import logging

# ุฅุนุฏุงุฏ ุณุฌู ุงูุฃุฎุทุงุก
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")

# ุฅุนุฏุงุฏ Flask
app = Flask(__name__)

# ูุณุงุฑ ุงููุฌูุฏ ุงูุฐู ูุญุชูู ุนูู ุฌููุน ุงูุฃูุงูุฑ ุงูุตูุชูุฉ
AUDIO_PATH = "/mnt/data/sounds"

# ุงูุชุญูู ูู ุฃู ุงููุฌูุฏ ููุฌูุฏ
if not os.path.exists(AUDIO_PATH):
    logging.error("โ ุงููุฌูุฏ ุงูุฎุงุต ุจุงูุฃูุงูุฑ ุงูุตูุชูุฉ ุบูุฑ ููุฌูุฏ!")
    os.makedirs(AUDIO_PATH)
    logging.info("โ ุชู ุฅูุดุงุก ุงููุฌูุฏ ุงูุฎุงุต ุจุงูุฃูุงูุฑ ุงูุตูุชูุฉ!")

# ุชุฌููุน ุฌููุน ุงูุฃูุงูุฑ ุงูุตูุชูุฉ ุงููุณุฌูุฉ
command_list = [file.replace(".wav", "") for file in os.listdir(AUDIO_PATH) if file.endswith(".wav")]

# ุชุนุฑูู ุงููููุฑูููู ูุงูุชุนุฑู ุนูู ุงูุตูุช
recognizer = sr.Recognizer()

# ูุงููุณ ุงูุฃูุงูุฑ ูุฑุฏูุฏ ุงููุนู
command_map = {
    "ุชุณุฌูู ุฏุฎูู": "โ ุชู ุชุณุฌูู ุงูุฏุฎูู!",
    "ุชุณุฌูู ุฎุฑูุฌ": "โ ุชู ุชุณุฌูู ุงูุฎุฑูุฌ!",
    "ุฅุถุงูุฉ ุตูุฑุฉ": "๐ธ ุชู ุฅุถุงูุฉ ุตูุฑุฉ ุฌุฏูุฏุฉ!",
    "ูุชุญ ุงููุงููุฑุง": "๐ท ูุชู ูุชุญ ุงููุงููุฑุง...",
    "ุฅุบูุงู ุงููุงููุฑุง": "๐ซ ูุชู ุฅุบูุงู ุงููุงููุฑุง...",
    "ุฅูุดุงุก ุญุณุงุจ": "๐ ูุชู ุฅูุดุงุก ุงูุญุณุงุจ!",
    "ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ": "๐ ูุชู ุงูุงูุชูุงู ุฅูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ!",
    "ูุจุงุชุงุชู": "๐ฟ ุนุฑุถ ูุงุฆูุฉ ูุจุงุชุงุชู!",
    "ุฌุฏูู ุงูุฑู": "๐ฆ ุนุฑุถ ุฌุฏูู ุงูุฑู!",
    "ุงุจุญุซ ุนู ูุจุชุชู": "๐ ุฌุงุฑู ุงูุจุญุซ ุนู ุงููุจุชุฉ...",
    "ูุณุงุนุฏุฉ": "โ ุนุฑุถ ูุงุฆูุฉ ุงููุณุงุนุฏุฉ!",
    "ุฎุฑูุฌ": "๐ ูุชู ุฅููุงู ุงููุธุงู!",
    # ุฅุถุงูุฉ ุฃูุงูุฑ ุฌุฏูู ุงูุฑู
    "ุฃุถู ุฅูู ุฌุฏูู ุงูุฑู": "๐ง ุชูุช ุฅุถุงูุฉ ุงููุจุงุช ุฅูู ุฌุฏูู ุงูุฑู!",
    "ุฃุถู ููุฑู": "๐ง ุชูุช ุฅุถุงูุฉ ุงููุจุงุช ุฅูู ุฌุฏูู ุงูุฑู!",
    "ุฅุถุงูุฉ ููุฑู": "๐ง ุชูุช ุฅุถุงูุฉ ุงููุจุงุช ุฅูู ุฌุฏูู ุงูุฑู!",
    "ุฃุถู ููุฌุฏูู": "๐ง ุชูุช ุฅุถุงูุฉ ุงููุจุงุช ุฅูู ุฌุฏูู ุงูุฑู!",
    "ุฅุถุงูุฉ ูุฌุฏูู ุงูุฑู": "๐ง ุชูุช ุฅุถุงูุฉ ุงููุจุงุช ุฅูู ุฌุฏูู ุงูุฑู!",
    "ุฃุถูู ููุฑู": "๐ง ุชูุช ุฅุถุงูุฉ ุงููุจุงุช ุฅูู ุฌุฏูู ุงูุฑู!",
    "ุฃุถูู ููุฑู": "๐ง ุชูุช ุฅุถุงูุฉ ุงููุจุงุช ุฅูู ุฌุฏูู ุงูุฑู!",
    "ุณูู ุงููุจุงุช": "๐ง ุชูุช ุฅุถุงูุฉ ุงููุจุงุช ุฅูู ุฌุฏูู ุงูุฑู!",
    "ุฌุฏููุฉ ุงูุฑู": "๐ง ุชูุช ุฅุถุงูุฉ ุงููุจุงุช ุฅูู ุฌุฏูู ุงูุฑู!"
}

@app.route("/command", methods=["POST"])
def handle_command():
    """ูุณุชูุจู ุงูุฃูุฑ ุงูุตูุชู ูู Flutter ููููุฐู."""
    command = request.form.get("command")
    plant_info = request.form.get("plant_info", "")  # ูุนูููุงุช ุงููุจุงุช (ุงุฎุชูุงุฑู)

    if not command:
        logging.warning("โ๏ธ ูู ูุชู ุงุณุชูุจุงู ุฃู ุฃูุฑ!")
        return jsonify({"error": "โ ูู ูุชู ุงุณุชูุจุงู ุฃู ุฃูุฑ!"}), 400

    logging.info(f"๐ข ุงุณุชูุจูุช ุงูุฃูุฑ ุงูุตูุชู: {command}")
    if plant_info:
        logging.info(f"๐ฑ ูุนูููุงุช ุงููุจุงุช: {plant_info}")

    # ูุญุต ุงูุฃูุงูุฑ ุงููุชุนููุฉ ุจุฌุฏูู ุงูุฑู
    watering_commands = [
        "ุฃุถู ุฅูู ุฌุฏูู ุงูุฑู", "ุฃุถู ููุฑู", "ุฅุถุงูุฉ ููุฑู", 
        "ุฃุถู ููุฌุฏูู", "ุฌุฏูู ุงูุฑู", "ุฅุถุงูุฉ ูุฌุฏูู ุงูุฑู", 
        "ุฃุถูู ููุฑู", "ุฃุถูู ููุฑู", "ุณูู ุงููุจุงุช", "ุฌุฏููุฉ ุงูุฑู"
    ]
    
    # ุงูุชุญูู ูู ูุฌูุฏ ุฃูุฑ ุฌุฏูู ุงูุฑู ูู ุงููุต
    is_watering_command = any(cmd in command for cmd in watering_commands)
    
    if is_watering_command:
        response = {
            "action": "navigate_to_watering_schedule",
            "message": "๐ง ุชูุช ุฅุถุงูุฉ ุงููุจุงุช ุฅูู ุฌุฏูู ุงูุฑู!",
            "plant_info": plant_info
        }
        logging.info("๐ ุชูููุฐ ุฃูุฑ ุฅุถุงูุฉ ุงููุจุงุช ุฅูู ุฌุฏูู ุงูุฑู")
        return jsonify(response), 200
    
    # ุงูุจุญุซ ุนู ุฃูุฑุจ ุชุทุงุจู ุจูู ุงูุฃูุงูุฑ ุงููุณุฌูุฉ
    best_match = difflib.get_close_matches(command, command_map.keys(), n=1, cutoff=0.5)

    if best_match:
        response_text = command_map[best_match[0]]
        action = best_match[0]
        
        response = {
            "action": action.replace(" ", "_"),
            "message": response_text
        }
        
        logging.info(f"โ ุชู ุชูููุฐ ุงูุฃูุฑ: {best_match[0]} - {response_text}")
        return jsonify(response), 200
    else:
        logging.warning("โ ูู ูุชู ุงูุชุนุฑู ุนูู ุงูุฃูุฑ!")
        return jsonify({"error": "โ ูู ูุชู ุงูุชุนุฑู ุนูู ุงูุฃูุฑ!"}), 400

def recognize_command():
    """ูุณุชูุน ุฅูู ุตูุช ุงููุณุชุฎุฏู ูููุงุฑู ุจุงูุฃูุงูุฑ ุงูุตูุชูุฉ ุงููุชุงุญุฉ."""
    with sr.Microphone() as source:
        logging.info("๐ค ุชุญุฏุซ ุงูุขู...")
        recognizer.adjust_for_ambient_noise(source)  # ุชูููู ุงูุถูุถุงุก
        audio = recognizer.listen(source)

    try:
        # ุงุณุชุฎุฏุงู Google Speech Recognition ูุชุญููู ุงูุตูุช ุฅูู ูุต
        recognized_text = recognizer.recognize_google(audio, language="ar-SA").strip()
        logging.info(f"โ ุชู ุงูุชุนุฑู ุนูู ุงูุฃูุฑ: {recognized_text}")

        # ุงูุจุญุซ ุนู ุฃูุฑุจ ุชุทุงุจู ุจูู ุงูุฃูุงูุฑ ุงููุณุฌูุฉ
        best_match = difflib.get_close_matches(recognized_text, command_map.keys(), n=1, cutoff=0.5)

        if best_match:
            return execute_command(best_match[0])  # ุชูููุฐ ุงูุฃูุฑ
        else:
            logging.warning("โ ูู ูุชู ุงูุชุนุฑู ุนูู ุงูุฃูุฑุ ุญุงูู ูุฑุฉ ุฃุฎุฑู.")
            return "โ ูู ูุชู ุงูุชุนุฑู ุนูู ุงูุฃูุฑุ ุญุงูู ูุฑุฉ ุฃุฎุฑู."
    
    except sr.UnknownValueError:
        logging.warning("๐ ูู ุฃููู ุงูุตูุชุ ุญุงูู ูุฑุฉ ุฃุฎุฑู.")
        return "๐ ูู ุฃููู ุงูุตูุชุ ุญุงูู ูุฑุฉ ุฃุฎุฑู."
    except sr.RequestError:
        logging.error("โ๏ธ ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช.")
        return "โ๏ธ ุญุฏุซ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช."

def execute_command(command):
    """ุชูููุฐ ุงูุฃูุงูุฑ ุจูุงุกู ุนูู ุงูุฃูุงูุฑ ุงูุตูุชูุฉ ุงููุณุฌูุฉ"""
    logging.info(f"๐ ุชูููุฐ ุงูุฃูุฑ: {command}")

    if command in command_map:
        response = command_map[command]
        logging.info(f"โ {response}")

        if command == "ูุชุญ ุงููุงููุฑุง":
            os.system("start camera")  # ุงุณุชุจุฏู ุจุฃูุฑ ููุงุณุจ ุฅุฐุง ููุช ุชุฑูุฏ ุชุดุบูู ุงููุงููุฑุง
        elif command == "ุฅุบูุงู ุงููุงููุฑุง":
            os.system("taskkill /IM camera.exe /F")  # ุฅุบูุงู ุงููุงููุฑุง (ุญุณุจ ุงููุธุงู)
        elif command == "ุฎุฑูุฌ":
            exit()

        return response

    logging.warning("๐ค ุงูุฃูุฑ ุบูุฑ ูุนุฑูู!")
    return "โ ุงูุฃูุฑ ุบูุฑ ูุนุฑูู!"

# ุชุดุบูู ุงูุณูุฑูุฑ
if __name__ == "__main__":
    logging.info("๐ ูุธุงู ุงูุชุนุฑู ุนูู ุงูุฃูุงูุฑ ุงูุตูุชูุฉ ุฌุงูุฒ!")
    app.run(host="0.0.0.0", debug=True, port=5000)